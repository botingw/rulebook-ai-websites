# Specification: Rulebook-AI CLI (Composable Packs)

**1. Overview**

The `rulebook-ai` command-line interface manages modular "Packs" that bundle AI rules and starter context files. Packs may come from the built-in library or from community contributions. Users build a project library of packs, optionally group them into reusable **Profiles**, and then apply the desired context to their workspace with an explicit **`project sync`** command. The CLI keeps user-owned context in `memory/` and `tools/` while tracking framework state in a hidden `.rulebook-ai/` directory.

**2. Core Concepts**

1.  **Source Repository (Framework):** Hosts a top-level `packs/` directory. Each pack follows the [Pack Structure Spec](pack_structure_spec.md): it must include `manifest.yaml`, `README.md`, and `rules/`, with optional `memory_starters/` and `tool_starters/`.
2.  **Target Repo:** Any project repository where packs are added.
3.  **Framework State Directory:** A hidden **`.rulebook-ai/`** directory inside the Target Repo. It stores:
    *   `.rulebook-ai/packs/`: local copies of every added pack.
    *   **`selection.json`**: an ordered source of truth for the pack library and any defined Profiles. Earlier packs win file conflicts during sync.
    *   **`file_manifest.json`**: tracks ownership of files created in `memory/` and `tools/` for safe cleanup.
    *   **`sync_status.json`**: records which packs or profile were last synced to each assistant along with a timestamp.
4.  **User Context Directories (`memory/`, `tools/`):** Version-controlled folders owned by the user. The CLI only adds new files here and never overwrites existing ones.
5.  **Target Platform Rules:** Assistant-specific rule files generated by `project sync`. For how rules are generated, see [Platform Rules Spec](platform_rules_spec.md). These outputs should be added to `.gitignore`.
6.  **Pack Sources:** The CLI ships with built-in packs and can install community packs discovered via a shared index. Community data model, cache location, and collision rules are defined in [`community_packs/spec.md`](../community_packs/spec.md).

**3. Features & Advantages**

*   **Composable Packs:** Multiple packs can coexist in a project. `selection.json` tracks both the pack library and any Profiles that group packs for reuse, preserving pack order for deterministic conflict resolution.
*   **Explicit Configuration and Applied State:** `selection.json` records configuration while `sync_status.json` captures what was last applied to each assistant with timestamps.
*   **Project-Controlled Context:** `memory/` and `tools/` hold the composed context and remain under version control.
*   **Community Ecosystem:** Users can discover and install community-created packs through the shared index described in [`community_packs/spec.md`](../community_packs/spec.md).
*   **Cleanliness:** Generated platform rules are kept out of version control, and framework state is isolated in `.rulebook-ai/`.
*   **Focused Cleaning:** `project clean-rules` removes only rule-related artifacts, preserving project memory and tools. `project clean` removes all framework state after confirmation.

**4. Project Sync Workflow**

The CLI regenerates Target Platform Rules only when the user explicitly runs **`rulebook-ai project sync`**. `packs` and `profiles` commands modify configuration but never touch `memory/`, `tools/`, or generated rules. `project sync` reads `selection.json`, composes context from the chosen packs, updates `file_manifest.json`, writes platform rules, and records results in `sync_status.json`.

**5. CLI Commands**

Commands are grouped into **packs**, **profiles**, and **project** categories. [`community_packs/spec.md`](../community_packs/spec.md) supplements these commands with the community index data model, cache location, slug resolution, and name‑collision rules.

*   **`rulebook-ai packs list`**
    *   **Action:** Lists available built-in and community packs.
    *   **Behavior:** Reads pack metadata from the Source Repository's `packs/` directory and the Local Index Cache; community packs are labeled `(community)` and no network access occurs.
    *   **Output:** Prints each pack's name, version, and description.
    *   **Use Case:** Explore available packs before selecting one to add to a project.

*   **`rulebook-ai packs update`**
    *   **Action:** Updates the Local Index Cache of community packs.
    *   **Behavior:** Fetches the latest `packs.json` from the Public Index Repository and stores it in the shared cache inside the Python package. Cache format and validation rules are detailed in [`community_packs/spec.md`](../community_packs/spec.md).
    *   **Use Case:** Refresh the list of discoverable community packs. This is the only `packs` subcommand that accesses the network.

*   **`rulebook-ai packs add <input...>`**
    *   **Action:** Adds one or more packs to the project's library from different sources.
    *   **Behavior:**
        1.  The `<input>` format determines the pack's source. The supported formats are:
            *   **`local:<path>`:** Installs a pack from a local filesystem path (e.g., `local:./my-pack`).
            *   **`github:<user>/<repo>[/path]`:** Installs a pack from a GitHub repository (e.g., `github:cool-org/awesome-pack`).
            *   **`<name>`:** Installs a pack by name. The CLI first searches for a built-in pack, then queries the community index.
        2.  The CLI resolves the pack source based on the input. If the source cannot be found or the format is invalid, the command aborts.
        3.  Validates the pack structure against [Pack Structure Spec](pack_structure_spec.md); any violation aborts the command.
        4.  Handles installation into `.rulebook-ai/packs/<name>/` with the following logic:
            *   **Name Collision (Different Source):** If a pack with the same `name` is already installed but from a *different* source (e.g., a community pack has the same name as a built-in pack), the command aborts with an error. This prevents ambiguity.
            *   **Re-installation (Same Source):** If a pack is already installed from the *same* source (e.g., re-running `packs add` for an existing pack), the CLI proceeds by removing the old directory and performing a fresh installation. This makes the operation idempotent and allows it to be used for refreshing/updating a pack.
            *   **New Installation:** If the name is not in use, the pack is installed directly.
        5.  Appends the chosen name and version to the ordered list in `selection.json` if it's not already present.
        6.  Does **not** modify `memory/`, `tools/`, or generated rules; users must run `project sync` to apply changes.
    *   **Use Case:** Expand the pack library from local, remote, or indexed sources.

*   **`rulebook-ai packs remove <name...>`**
    *   **Action:** Removes pack sources from the project's library.
    *   **Behavior:**
        1.  Deletes the pack's entry from `selection.json`.
        2.  Removes the pack directory from `.rulebook-ai/packs/`.
        3.  Leaves existing context files untouched until the next `project sync` or `project clean-context`.
    *   **Use Case:** Prune packs that are no longer needed.

*   **`rulebook-ai packs status`**
    *   **Action:** Displays the configured pack library and defined Profiles from `selection.json`.
    *   **Output:** Lists all packs in library order followed by each profile and its constituent packs.
    *   **Use Case:** Understand available packs and their compositions.

*   **`rulebook-ai profiles create <name>` / `delete <name>` / `add <pack> --to <profile>` / `remove <pack> --from <profile>` / `list`**
    *   **Action:** Manage named Profiles that group packs for reuse.
    *   **Use Case:** Maintain reusable contexts for recurring tasks.

*   **`rulebook-ai project sync [--assistant <name>...] [--profile <name>] [--pack <name>...]`**
    *   **Action:** Applies context to the workspace. If no packs or profile are specified, all packs are used.
    *   **Behavior:**
        1.  Reads `selection.json` to determine the pack list (all, profile, or ad‑hoc pack flags).
        2.  For each selected pack, copies starter files into `memory/` and `tools/` only if they do not already exist, recording creations in `file_manifest.json`.
        3.  Rebuilds assistant-specific rule files, removing any previous generated rules.
        4.  Writes `sync_status.json` noting timestamp, assistant, and context source.
    *   **Use Case:** Refresh rules after configuration changes or when switching contexts.

*   **`rulebook-ai project status`**
    *   **Action:** Shows which context was last synced to each assistant using `sync_status.json`.
    *   **Output:** For each assistant, reports last sync timestamp and whether context came from all packs, a profile, or an explicit pack list.
    *   **Use Case:** Verify the live state of the workspace.

*   **`rulebook-ai project clean-context [--action delete|keep] [--force]`**
    *   **Action:** Removes orphaned starter files from `memory/` and `tools/` using `file_manifest.json`.
    *   **Behavior:** Lists files tied to removed packs and prompts to delete or keep them. `--action` sets the default choice and `--force` skips prompts.
    *   **Use Case:** Safely clean up context files after removing packs.

*   **`rulebook-ai project clean`**
    *   **Action:** Removes `.rulebook-ai/`, `memory/`, `tools/`, and all generated rules.
    *   **Behavior:** Destructive operation that **must prompt for user confirmation**. Parent directories (e.g., `.github/`) are removed if they become empty.
    *   **Output:** Prints a prominent warning, a confirmation prompt, and a summary of removed paths.
    *   **Use Case:** Completely uninstall Rulebook-AI components from a project.

*   **`rulebook-ai project clean-rules`**
    *   **Action:** Deletes `.rulebook-ai/` and generated rule files while preserving `memory/` and `tools/`.
    *   **Behavior:** If a rule file is the only item in a directory, its parent directory is also removed.
    *   **Use Case:** Revert to a clean state without generated rules.

*   **`rulebook-ai bug-report`**
    *   **Action:** Prints the GitHub issue tracker URL and attempts to open it in the user's default browser.

*   **`rulebook-ai rate-ruleset`**
    *   **Action:** Prints the ratings and reviews wiki URL and attempts to open it in the user's default browser.

